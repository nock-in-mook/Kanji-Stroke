# DEVLOG - 漢字書き順ジェネレーター

---

## 2026-03-01（セッション5）

### スナッププレビューの実装
- **問題**: タップするまでスナップ先がわからず、配置後にズレる
- **解決**: スナップカーソル（オレンジのクロスヘア + 中心ドット）を追加
  - pointerdown/pointermove でスナップ先をリアルタイム表示
  - pointerup では `lastSnappedPos` を使い、プレビュー位置に正確に配置

### 点マーカーの改良
- **問題**: 塗りつぶしの丸だと、点の中心位置が見えない
- **解決**: 中抜き円 + 中心ドット(r=2) + 番号を左上に小さく表示
  - 中心がどこにあるか正確に視認できるようになった

### 中心線アルゴリズムの進化

#### v1: 走査線方式（不採用）
- 水平・垂直に3px間隔で走査 → 断面中点をストローク別にグループ化
- **問題**: 斜め・曲線の画では中心がアウトラインの外にはみ出す
- 原因: 走査方向がストロークに対して斜めなので、断面中点≠真の中心

#### v1.5: 走査線 + pointInPolygon フィルタ（改善不十分）
- アウトライン外の中心点を除外 → はみ出しは減ったが根本解決にならず
- 水平・垂直の両方が同じ斜め画を検出 → 2本の平行線が出る問題も発生
- マージ・平均化を試みるも効果限定的

#### v2: Zhang-Suen 細線化 + ポリゴンラスタライズ（改善不十分）
- アウトライン多角形をビットマップに描画 → Zhang-Suen 細線化 → 骨格抽出
- 交差部分は改善されたが、ポリゴンが39点の直線近似のため曲線部分でズレが残る

#### v3: Zhang-Suen 細線化 + Canvas フォント描画（採用）
- **根本解決**: アウトラインポリゴンではなく、Canvas に実際のフォントを描画
- `ctx.fillText()` でKlee Oneを300x300のCanvasに描画 → ピクセルデータ取得
- Zhang-Suen 細線化で1ピクセル幅の骨格に → ポリラインとして表示
- **メリット**:
  - フォントの実際の曲線形状に完全一致
  - GLYPH_DATA 不要 → 任意の漢字で中心線が動作
  - アウトライン内に必ず収まる（骨格は内部ピクセルのみ）

### Zhang-Suen 細線化アルゴリズムの仕組み
```
1. フォントをCanvasに描画 → alpha > 128 のピクセルを前景(1)とする
2. 境界ピクセルを条件付きで削除（形の連結性を壊さない）
   - 8近傍の黒ピクセル数が2〜6（孤立点や完全に囲まれた点は除外）
   - 0→1遷移が1回だけ（連結性を保証）
   - Step1/Step2で異なる方向条件（北西/南東の交互削り）
3. 削除できるピクセルがなくなるまで繰り返し → 1px幅の骨格が残る
4. 骨格ピクセルを端点から順にたどってポリラインに変換
```

### 現状
- エディタの操作感が大幅に改善
- 中心線スナップが全漢字で動作
- Canvasベースライン: y=259（CSS flexbox center + Klee One メトリクスに合わせて計算）

---

## 2026-02-28（セッション4）

### フリーハンド描画の限界と方式転換

#### フリーハンド描画の問題（Plan A検証）
- 「九」でフリーハンド描画をテスト → カクカク（Douglas-Peucker EPSILON 3.0→1.5 に調整しても改善不足）
- **根本的な問題**: 始点と終点が定まらないため書き直し回数が尋常じゃなくなる
- ユーザー判断: フリーハンド方式は不採用

#### 点配置方式への移行（Plan B）
- **方式**: タップで点を配置 → Catmull-Rom スプラインで滑らかな曲線を自動生成
- editor.html を完全書き換え
- Catmull-Rom → 3次ベジェ変換: `CP1 = P1 + (P2-P0)/6`, `CP2 = P2 - (P3-P1)/6`
- 2点 = 直線、3点以上 = 滑らかな曲線が自動生成
- リアルタイムプレビュー（半透明）で配置中に確認可能

### タッチ操作の改善
- **問題1**: 2本指ピンチズームで線が描かれてしまう
  - `touch-action: none` → `pinch-zoom` → `manipulation` に変更
  - マルチタッチ検出で描画キャンセル
- **問題2**: キャンバス上でスクロールできない
  - `touch-action: manipulation` + touchstart/touchmove で1本指のみ preventDefault
  - 結果: 1本指=点配置、2本指=スクロール＆ピンチズーム

### 「九」のグリフデータ追加
- `extract_points.py 九` で座標抽出
- GLYPH_DATA に九のアウトライン（39点）を追加
- centerLines は直線のみで曲線ストロークに対応不可 → 手動 centerLines を廃止

### 点のドラッグ移動
- 配置済みの点を20px以内でタッチ → ドラッグ開始
- ドラッグ中は点が大きくなり色反転（視覚フィードバック）
- 40px Y方向オフセット（指の上に浮く）
- ドラッグ中もリアルタイムに曲線プレビュー更新

### 中心線スナップの実装

#### v1: レイキャスト方式（不採用）
- タップ位置から水平・垂直レイキャスト → アウトライン交点ペアの中点
- **問題**: フチに引っ張られる（交点ペアの選択が不安定）

#### v2: 走査線方式（採用）
- アウトラインを3px間隔で水平走査 → 各断面中点を計算 → 縦画の中心線
- 同様に垂直走査 → 横画の中心線
- 隣接走査線の中点を近傍マッチング（15px以内）で連結 → ストローク別ポリライン
- 断面幅 50px 以下のみ対象（広い領域はスキップ）
- **表示**: オレンジ点線（stroke-dasharray: 4,4, opacity: 0.6）
- **スナップ**: 全中心点から25px以内の最近傍にスナップ
- チェックボックスで ON/OFF 切替（デフォルト ON）
- 漢字入力変更時にキャッシュ自動無効化＆再計算

### 現状
- エディタ v2 は点配置方式で実用レベル
- 山・九の2文字にアウトラインデータあり
- 中心線の走査線検出は縦画・横画とも正常動作
- はね・はらいの終端表現は未実装

---

## 2026-02-28（セッション2〜3）

### フォント統一問題の解決
- **問題**: extract_points.py が NotoSansJP（ゴシック体）で抽出した座標を、表示は Noto Serif JP（明朝体）で重ねていた → 字形が違うのでズレる
- **調査**: 抽出にも表示にも使えるフォントを比較検討
  - Klee One SemiBold（硬筆体） ← 採用
  - BIZ UD Mincho、Noto Serif JP、Zen Old Mincho も比較
- **font_compare.html** を作成して4フォント×8漢字を比較、Cloudflare Pages にデプロイしてスマホで確認
- **決定**: Klee One SemiBold — 硬筆体でとめ・はね・はらいがはっきり、SIL OFL 1.1で安全

### フォント導入
- `fonts/KleeOne-SemiBold.ttf`（8.5MB）をプロジェクトにダウンロード
- editor.html / index.html を `@font-face` でセルフホスティングに変更
- extract_points.py のフォントパスも変更

### 座標系の修正
- **問題**: Python 抽出の座標とブラウザ表示の座標がスケール・位置ともにズレる
- **原因**: extract_points.py がバウンディングボックスフィットで計算していたが、ブラウザはCSS font-size / flexbox center / line-height:1 の計算で描画
- **修正**: extract_points.py を CSS と同じ座標変換に書き直し
  - `scale = font_size / units_per_em`（250/1000 = 0.25）
  - baseline_y = line_box_top + half_leading + ascent * scale
  - Y軸反転: `ny = baseline_y - y * scale`
- Klee One メトリクス: unitsPerEm=1000, ascent=1160, descent=-288, advanceWidth=1000
- 修正後、アウトライン座標がフォント表示とぴったり一致

### GLYPH_DATA 形式の変更
- 旧: `contours[]`（4つの矩形 = Noto Sans JP の構造）
- 新: `outline[]`（1つの連続多角形 = Klee One の構造）+ `centerLines[]`（各画の中心線）

### エディタ調整モードの実装

#### v1: 全点ドラッグ
- outline（灰色）と centerLine（色付き）の全点を表示
- 色付き点のみドラッグ可能に

#### v2: 指オフセット
- ドラッグ中の点が指の下に隠れる問題
- SVG座標で40px上にオフセットして描画（指の上に浮く）

#### v3: 線選択方式
- 点が重なっている箇所で狙った点をタップできない問題
- 解決: 先に線をタップして選択 → 選択した線の端点のみ大きく表示＆ドラッグ可能
- `distToSegment()` で線分への最短距離を計算、30px以内でタップ判定
- 未選択の線は薄く表示（opacity: 0.3）

#### v4: スナップ機能
- **点マージ**: ドラッグ中の端点が他の端点に15px以内に接近 → 同じ座標にスナップ
- **線スナップ**: ドラッグ中の端点が他の中心線に15px以内に接近 → 線上の最近点にスナップ
- 両方ともチェックボックスで ON/OFF 切り替え可能（デフォルトON）
- 調整モード中のみスナップ設定が表示される

### 現状
- editor.html のエディタ機能は実用レベルに到達
- 「山」の centerLines データはまだ手動設定のみ
- はね・はらいの終端表現は未実装

### 次回やること
- はね・はらいの終端表現（可変太さストローク）
- 複数漢字対応
- centerLines → index.html アニメーションへの自動変換

---

## 2026-02-28（セッション1）

### やったこと
- プロジェクト初期整備
  - CLAUDE.md 作成（技術知見・実験経緯・今後の方針を記録）
  - .gitignore 作成（.wrangler/ と一時ファイルを除外）
  - index.html の「山」ストローク座標を微調整（stroke-width 10→12）
  - リモートバッチファイル作成（remote_bat_Kanji_Stroke.bat）

### 現状
- 「山」のアニメーションは動作する
- SVGパス座標の精度が課題（フォントオーバーレイとのズレが大きい）
- Cloudflare Pages にデプロイ済み: https://kanji-stroke-a8h.pages.dev

---

## 2026-02-27（初期実装）

### やったこと
- アニメーションエンジン実装（CSS transition + stroke-dashoffset）
- Noto Serif JP フォントオーバーレイ実装
- UI実装（スタート / リセット / 参照ON-OFF / 色分けトグル）
- Cloudflare Pages デプロイ

### 技術選定の経緯
- SVG SMIL animate → モバイル非対応で不採用
- JS + CSS transition → 全環境で安定動作、採用
