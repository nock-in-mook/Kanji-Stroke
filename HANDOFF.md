# 引き継ぎメモ 2026-02-28（セッション4）

## 現在の状況

### エディタ v2: 点配置方式（完全書き換え済み）

フリーハンド描画方式を廃止し、**点を配置して曲線を生成する方式**に完全移行した。

#### 操作フロー
1. 漢字を入力欄に入力 → フォント参照（薄いグレー）が表示
2. キャンバス上をタップして点を配置（番号付きの白丸で表示）
3. 2点以上で半透明のプレビュー曲線（Catmull-Rom スプライン）がリアルタイム表示
4. 「画を確定」で曲線を確定、次の画へ
5. 全画完了後「JSON出力」でデータ書き出し

#### 現在の機能
- **点配置**: タップで番号付き点を配置
- **点のドラッグ**: 配置済みの点を長押し＆ドラッグで微調整（40px指オフセット付き）
- **Catmull-Rom スプライン**: 配置した点を通る滑らかな曲線を自動生成
- **中心スナップ**: フォントアウトラインの走査線解析で中心線を検出、タップ/ドラッグ時に自動スナップ
- **中心線表示**: オレンジの点線でストロークの中心線を常時表示（ON/OFF切替可）
- **タッチ操作**: 1本指=点配置/ドラッグ、2本指=スクロール＆ピンチズーム
- **アンドゥ**: 「点を消す」「画を消す」「全消し」
- **フォント参照**: Klee One の薄いグレー文字を背景表示
- **アウトライン表示**: フォントのアウトライン多角形を半透明で重ね表示（参照を表示ボタン）
- **JSON出力 / コピー**

### 中心線スナップの仕組み（走査線方式）
```
1. アウトラインを水平に3px間隔で走査
   → 各走査線とアウトラインの交点を求める
   → 交点ペアの中点 = その高さでのストローク中心
   → 縦画の中心線が検出される

2. 同様に垂直に走査 → 横画の中心線が検出される

3. 隣接走査線の中点を近傍マッチングで連結 → ストロークごとのポリライン化

4. 表示: オレンジの点線（stroke-dasharray: 4,4）
5. スナップ: 全中心点から25px以内の最近傍にスナップ
```

### GLYPH_DATA の構造（v2）
```javascript
const GLYPH_DATA = {
  '山': {
    outline: [[85.5,263.0], ...]   // Klee One アウトライン座標（31点）
  },
  '九': {
    outline: [[265.8,217.2], ...]  // 39点
  }
};
// centerLines は廃止。走査線方式でアウトラインから自動計算する。
```

### フォント・座標系 → 完了（変更なし）
- Klee One SemiBold（`fonts/KleeOne-SemiBold.ttf`, 8.5MB）
- extract_points.py でCSS座標系と一致する座標を抽出
- メトリクス: unitsPerEm=1000, ascent=1160, descent=-288

## ファイル構成
```
Kanji_Stroke/
├── index.html          # アニメーションビューア（「山」3画のデモ）
├── editor.html         # 書き順エディタ v2（点配置 + Catmull-Rom、メイン開発中）
├── extract_points.py   # フォントからグリフ座標抽出（Klee One対応済み）
├── font_compare.html   # フォント比較ページ（Klee One選定時に使用）
├── fonts/
│   └── KleeOne-SemiBold.ttf
├── CLAUDE.md           # プロジェクト説明・技術知見
├── ROADMAP.md          # ロードマップ
├── DEVLOG.md           # 開発ログ
└── HANDOFF.md          # このファイル
```

## 次にやること

### 最優先: エディタの実用性向上
- 確定済みストロークの点もドラッグ編集できるようにする
- はね・はらいの終端表現（Catmull-Rom の終端を細くする等）
- 複数漢字のデータを追加（GLYPH_DATA に山・九以外も）

### その他の候補
- エディタ上でアニメーションプレビュー（描いた曲線をその場で再生）
- JSON出力 → index.html のアニメーションへの自動変換パイプライン
- 小1配当漢字80字のデータ量産
