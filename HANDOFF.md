# 引き継ぎメモ 2026-03-01（セッション5）

## 現在の状況

### エディタ v2: 点配置方式（大幅改良済み）

**点を配置して曲線を生成する方式**で、スナップ・プレビュー・中心線検出が実用レベルに到達。

#### 操作フロー
1. 漢字を入力欄に入力 → フォント参照（薄いグレー）+ 中心線（オレンジ点線）が表示
2. キャンバス上をタップ → スナップカーソル（クロスヘア）で配置先をプレビュー
3. 指を離すとプレビュー位置に正確に点を配置
4. 2点以上で半透明のプレビュー曲線（Catmull-Rom スプライン）がリアルタイム表示
5. 「画を確定」で曲線を確定、次の画へ
6. 全画完了後「JSON出力」でデータ書き出し

#### 現在の機能
- **点配置**: タップで中抜き円+中心ドット+番号（左上）で配置
- **スナッププレビュー**: タッチ中にクロスヘアでスナップ先をリアルタイム表示
- **点のドラッグ**: 配置済みの点を長押し＆ドラッグで微調整（40px指オフセット付き）
- **Catmull-Rom スプライン**: 配置した点を通る滑らかな曲線を自動生成
- **中心スナップ**: Zhang-Suen細線化で全漢字の中心線を自動検出、25px以内でスナップ
- **中心線表示**: オレンジの点線でストロークの中心線を常時表示（ON/OFF切替可）
- **タッチ操作**: 1本指=点配置/ドラッグ、2本指=スクロール＆ピンチズーム
- **アンドゥ**: 「点を消す」「画を消す」「全消し」
- **フォント参照**: Klee One の薄いグレー文字を背景表示
- **アウトライン表示**: フォントのアウトライン多角形を半透明で重ね表示（参照を表示ボタン）
- **JSON出力 / コピー**

### 中心線検出の仕組み（Zhang-Suen 細線化）
```
1. Canvas に Klee One フォントで漢字を描画（300x300）
2. alpha > 128 のピクセルを前景としてビットマップ化
3. Zhang-Suen 細線化で境界ピクセルを反復削除 → 1px幅の骨格が残る
4. 骨格ピクセルを端点から順にたどってポリラインに変換
5. 3px間隔に間引きしてSVG点線として描画

特徴:
- GLYPH_DATA 不要 → 任意の漢字で動作
- フォントの実際の曲線に完全一致
- 骨格は必ずアウトライン内部に収まる
```

### Canvas描画の座標合わせ
```javascript
ctx.font = '600 250px "Klee One"';
ctx.textBaseline = 'alphabetic';
ctx.fillText(kanji, 150, 259);  // baseline=259
// Klee One: ascent=1160, descent=288, unitsPerEm=1000
// 計算: line_box_top(25) + half_leading(-56) + ascent_px(290) = 259
```

### フォント・座標系 → 完了（変更なし）
- Klee One SemiBold（`fonts/KleeOne-SemiBold.ttf`, 8.5MB）
- extract_points.py でCSS座標系と一致する座標を抽出
- メトリクス: unitsPerEm=1000, ascent=1160, descent=-288

## ファイル構成
```
Kanji_Stroke/
├── index.html          # アニメーションビューア（「山」3画のデモ）
├── editor.html         # 書き順エディタ v2（点配置 + Catmull-Rom、メイン開発中）
├── extract_points.py   # フォントからグリフ座標抽出（Klee One対応済み）
├── font_compare.html   # フォント比較ページ（Klee One選定時に使用）
├── fonts/
│   └── KleeOne-SemiBold.ttf
├── CLAUDE.md           # プロジェクト説明・技術知見
├── ROADMAP.md          # ロードマップ
├── DEVLOG.md           # 開発ログ
└── HANDOFF.md          # このファイル
```

## 次にやること

### 最優先: エディタの実用性向上
- 確定済みストロークの点もドラッグ編集できるようにする
- はね・はらいの終端表現（Catmull-Rom の終端を細くする等）

### その他の候補
- エディタ上でアニメーションプレビュー（描いた曲線をその場で再生）
- JSON出力 → index.html のアニメーションへの自動変換パイプライン
- 小1配当漢字80字のデータ量産
